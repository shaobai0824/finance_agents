"""
LegalExpertAgent with LLM - æ³•å¾‹å°ˆå®¶ (ä½¿ç”¨çœŸå¯¦ LLM)

å¯¦ä½œ Linus å“²å­¸ï¼š
1. ç°¡æ½”åŸ·å¿µï¼šç›´æ¥å›ç­”æ³•è¦å•é¡Œï¼Œé¿å…å†—é•·è§£é‡‹
2. å¥½å“å‘³ï¼šæº–ç¢ºå¼•ç”¨æ³•æ¢å’Œå¯¦å‹™è¦‹è§£
3. å¯¦ç”¨ä¸»ç¾©ï¼šæä¾›å¯æ“ä½œçš„åˆè¦å»ºè­°
4. Never break userspaceï¼šä¸€è‡´çš„æ³•å¾‹æ„è¦‹æ ¼å¼
"""

import logging
from datetime import datetime
from typing import Any, Dict, List, Optional

from .base_agent import AgentType, MessageType, BaseAgent


class LegalExpertAgentLLM(BaseAgent):
    """æ³•å¾‹å°ˆå®¶ä»£ç†äºº (ä½¿ç”¨çœŸå¯¦ LLM)

    ç‰¹è‰²ï¼š
    - ä½¿ç”¨ GPT-4o-mini ç”Ÿæˆå°ˆæ¥­æ³•å¾‹å»ºè­°
    - å°ˆæ³¨é‡‘èæŠ•è³‡ç›¸é—œæ³•è¦
    - ä¸ä½¿ç”¨ RAGï¼Œç´”ä¾æ“šæ³•å¾‹çŸ¥è­˜
    - æä¾›æº–ç¢ºçš„æ³•æ¢å¼•ç”¨å’Œå¯¦å‹™å»ºè­°
    """

    def __init__(self, name: str = "æ³•å¾‹å°ˆå®¶", knowledge_retriever=None):
        super().__init__(
            agent_type=AgentType.LEGAL_EXPERT,
            name=name,
            use_rag=False,  # æ³•å¾‹å°ˆå®¶ä¸ä½¿ç”¨ RAG
            knowledge_retriever=None
        )

        # é‡‘èæ³•è¦å°ˆæ¥­é ˜åŸŸ
        self.legal_domains = {
            "securities_law": "è­‰åˆ¸äº¤æ˜“æ³•",
            "banking_law": "éŠ€è¡Œæ³•",
            "insurance_law": "ä¿éšªæ³•",
            "trust_law": "ä¿¡è¨—æ³•",
            "tax_law": "ç¨…æ³•",
            "consumer_protection": "æ¶ˆè²»è€…ä¿è­·æ³•",
            "money_laundering": "æ´—éŒ¢é˜²åˆ¶æ³•",
            "personal_data": "å€‹äººè³‡æ–™ä¿è­·æ³•"
        }

        # å¸¸è¦‹æ³•è¦å•é¡Œé¡å‹
        self.legal_categories = {
            "investment_regulations": "æŠ•è³‡æ³•è¦",
            "financial_disclosure": "è³‡è¨Šæ­éœ²",
            "investor_protection": "æŠ•è³‡äººä¿è­·",
            "compliance_requirements": "åˆè¦è¦æ±‚",
            "risk_warnings": "é¢¨éšªè­¦èª",
            "licensing_requirements": "åŸ·ç…§è¦æ±‚"
        }

    def _get_system_prompt(self) -> str:
        """æ³•å¾‹å°ˆå®¶çš„ç³»çµ±æç¤ºè©"""
        return """ä½ æ˜¯å°ˆæ¥­çš„å°ç£æ³•å¾‹åˆè¦å°ˆå®¶ï¼Œå°ˆç²¾æ–¼é‡‘èç›¸é—œæ³•è¦ã€‚

# å°ˆæ¥­é ˜åŸŸ
- å°ç£ç¨…å‹™æ³•è¦ (æ‰€å¾—ç¨…æ³•ã€ç‡Ÿæ¥­ç¨…æ³•ã€éºç”¢åŠè´ˆèˆ‡ç¨…æ³•)
- é‡‘èæŠ•è³‡æ³•è¦ (è­‰åˆ¸äº¤æ˜“æ³•ã€éŠ€è¡Œæ³•ã€ä¿éšªæ³•ã€æŠ•ä¿¡æŠ•é¡§æ³•)
- é‡‘èæ¶ˆè²»è€…ä¿è­·ç›¸é—œæ³•è¦
- æ´—éŒ¢é˜²åˆ¶èˆ‡æ³•ä»¤éµå¾ª

# å›æ‡‰æº–å‰‡
1. **æº–ç¢ºæ€§ç¬¬ä¸€**: åŸºæ–¼ç¾è¡Œå°ç£æ³•è¦æä¾›å»ºè­°
2. **é¢¨éšªè­¦ç¤º**: æ˜ç¢ºæŒ‡å‡ºæ³•å¾‹é¢¨éšªå’Œæ³¨æ„äº‹é …
3. **å¯¦å‹™å°å‘**: æä¾›å…·é«”å¯è¡Œçš„åˆè¦å»ºè­°
4. **å…è²¬è²æ˜**: æé†’ä½¿ç”¨è€…éœ€è«®è©¢å°ˆæ¥­å¾‹å¸«æˆ–æœƒè¨ˆå¸«

# å›æ‡‰æ ¼å¼
ğŸ“‹ **æ³•è¦åˆ†æ**
- ç›¸é—œæ³•æ¢æˆ–è¦å®š
- é©ç”¨æƒ…å¢ƒèªªæ˜

âš ï¸ **é¢¨éšªæé†’**
- æ½›åœ¨æ³•å¾‹é¢¨éšª
- é•æ³•å¾Œæœèªªæ˜

ğŸ’¡ **åˆè¦å»ºè­°**
- å…·é«”åŸ·è¡Œå»ºè­°
- æ³¨æ„äº‹é …æé†’

âš–ï¸ **å…è²¬è²æ˜**
æœ¬å»ºè­°åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›åŸ·è¡Œå‰è«‹è«®è©¢å°ˆæ¥­å¾‹å¸«æˆ–æœƒè¨ˆå¸«ã€‚

# é™åˆ¶
- ä¸æä¾›å…·é«”å€‹æ¡ˆæ³•å¾‹æ„è¦‹
- ä¸æ›¿ä»£å°ˆæ¥­æ³•å¾‹è«®è©¢
- åƒ…å°±ä¸€èˆ¬æ€§æ³•è¦å•é¡Œæä¾›èªªæ˜"""

    async def can_handle(self, query: str) -> float:
        """è©•ä¼°æ˜¯å¦èƒ½è™•ç†æ³•å¾‹ç›¸é—œæŸ¥è©¢"""
        query_lower = query.lower()

        # è¨ˆç®—æ³•å¾‹é—œéµå­—åŒ¹é…åº¦
        legal_keywords = [
            "æ³•è¦", "åˆè¦", "ç¨…å‹™", "æ³•å¾‹", "è¦ç¯„", "æ¢æ–‡", "ç›£ç®¡",
            "é‡‘èæ³•", "æŠ•è³‡æ³•è¦", "ç¨…å‹™è¦åŠƒ", "æ³•å¾‹é¢¨éšª",
            "legal", "regulation", "compliance", "tax", "law",
            "æ‰€å¾—ç¨…", "ç‡Ÿæ¥­ç¨…", "éºç”¢ç¨…", "è´ˆèˆ‡ç¨…", "ç¨…å‹™", "å ±ç¨…", "æ‰£ç¹³", "ç¶œæ‰€ç¨…",
            "è­‰åˆ¸äº¤æ˜“æ³•", "æŠ•ä¿¡æŠ•é¡§æ³•", "éŠ€è¡Œæ³•", "ä¿éšªæ³•", "æ´—éŒ¢é˜²åˆ¶æ³•",
            "é‡‘èæ¶ˆè²»è€…ä¿è­·æ³•", "å­˜æ¬¾ä¿éšªæ¢ä¾‹", "ä¿¡è¨—æ³•", "ç¥¨æ“šæ³•",
            "å…¬å¸æ³•", "å•†æ¥­æœƒè¨ˆæ³•", "å‹åŸºæ³•", "å€‹äººè³‡æ–™ä¿è­·æ³•"
        ]

        keyword_count = sum(1 for keyword in legal_keywords if keyword in query_lower)
        keyword_score = min(keyword_count / 5, 1.0) * 0.6

        # æª¢æŸ¥æ˜¯å¦åŒ…å«æ³•å¾‹ç›¸é—œè©å½™
        legal_terms = [
            "æ³•è¦", "æ³•å¾‹", "ç¨…", "ç¨…å‹™", "æ³•æ¢", "åˆæ³•", "é•æ³•", "è¦å®š", "æ¢ä¾‹",
            "ç”³å ±", "æ‰£ç¹³", "å…ç¨…", "èª²ç¨…", "ç½°æ¬¾", "è™•ç½°", "åˆè¦", "é¢¨éšª"
        ]

        legal_term_count = sum(1 for term in legal_terms if term in query)
        legal_term_score = min(legal_term_count / 3, 1.0) * 0.4

        final_score = keyword_score + legal_term_score

        self.logger.debug(
            f"æ³•å¾‹å°ˆå®¶èƒ½åŠ›è©•åˆ†: {final_score:.2f} "
            f"(é—œéµå­—: {keyword_score:.2f}, æ³•å¾‹è©å½™: {legal_term_score:.2f})"
        )

        return final_score

    async def _build_prompt(self,
                          query: str,
                          knowledge_results: List[Dict],
                          personal_context: Dict[str, Any],
                          user_profile: Dict[str, Any] = None) -> str:
        """æ§‹å»ºæ³•å¾‹å°ˆå®¶å°ˆæ¥­æç¤ºè©"""

        # åˆ†ææ³•å¾‹å•é¡Œé¡å‹
        legal_category = self._classify_legal_category(query)
        category_name = self.legal_categories.get(legal_category, "ä¸€èˆ¬æ³•å¾‹è«®è©¢")

        prompt = f"""ä½ æ˜¯ä¸€ä½å°ˆç²¾é‡‘èæ³•è¦çš„åŸ·æ¥­å¾‹å¸«ï¼Œè«‹æ ¹æ“šå°ç£ç›¸é—œæ³•è¦å›ç­”ä»¥ä¸‹å•é¡Œï¼š

æ³•å¾‹è«®è©¢å•é¡Œï¼š{query}

å•é¡Œé¡å‹ï¼š{category_name}

è«‹æä¾›å°ˆæ¥­çš„æ³•å¾‹æ„è¦‹ï¼ŒåŒ…å«ï¼š

âš–ï¸ **æ³•å¾‹åˆ†æ**

ğŸ“‹ **ç›¸é—œæ³•è¦**
- æ˜ç¢ºå¼•ç”¨é©ç”¨çš„æ³•æ¢æ¢æ–‡
- èªªæ˜æ³•è¦çš„ç«‹æ³•ç›®çš„å’Œè¦ç¯„ç¯„åœ
- æåŠç›¸é—œçš„ä¸»ç®¡æ©Ÿé—œå’ŒåŸ·æ³•å–®ä½

ğŸ” **å¯¦å‹™è¦‹è§£**
- åŸºæ–¼æ³•è¦æ¢æ–‡çš„è§£é‡‹å’Œé©ç”¨
- åƒè€ƒä¸»ç®¡æ©Ÿé—œçš„å‡½é‡‹å’Œå¯¦å‹™ä½œæ³•
- èªªæ˜å¯èƒ½çš„æ³•å¾‹é¢¨éšªå’Œå¾Œæœ

ğŸ’¡ **åˆè¦å»ºè­°**
- å…·é«”çš„éµæ³•æªæ–½å’Œæ³¨æ„äº‹é …
- å»ºè­°çš„å…§æ§åˆ¶åº¦å’Œç¨‹åº
- é é˜²æ³•å¾‹é¢¨éšªçš„æœ€ä½³åšæ³•

âš ï¸ **é¢¨éšªæé†’**
- é•åç›¸é—œæ³•è¦çš„æ³•å¾‹è²¬ä»»
- å¯èƒ½é¢è‡¨çš„è¡Œæ”¿è™•åˆ†æˆ–åˆ‘è²¬
- æ°‘äº‹è²¬ä»»å’Œè³ å„Ÿé¢¨éšª

ğŸ“ **å»ºè­°è¡Œå‹•**
- ç«‹å³æ‡‰æ¡å–çš„åˆè¦æªæ–½
- å¾ŒçºŒæ‡‰æŒçºŒæ³¨æ„çš„æ³•è¦è®Šå‹•
- å¿…è¦æ™‚å°‹æ±‚å°ˆæ¥­æ³•å¾‹è«®è©¢çš„æ™‚æ©Ÿ

è¦æ±‚ï¼š
1. å¼•ç”¨çš„æ³•æ¢è¦æº–ç¢ºï¼ŒåŒ…å«æ¢æ–‡å…§å®¹
2. åˆ†æè¦å®¢è§€ä¸­ç«‹ï¼Œé¿å…ä¸»è§€åˆ¤æ–·
3. å»ºè­°è¦å…·é«”å¯è¡Œï¼Œç¬¦åˆå¯¦å‹™æ“ä½œ
4. ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œæ¡ç”¨æ³•å¾‹å°ˆæ¥­ç”¨èª
5. çµæ§‹æ¸…æ™°ï¼Œé‡é»æ˜ç¢º
6. åŒ…å«é©ç•¶çš„å…è²¬è²æ˜

è«‹åŸºæ–¼å°ç£ç¾è¡Œæ³•è¦å’Œå¯¦å‹™ï¼Œæä¾›å°ˆæ¥­çš„æ³•å¾‹æ„è¦‹ã€‚"""

        return prompt

    def _classify_legal_category(self, query: str) -> str:
        """åˆ†é¡æ³•å¾‹å•é¡Œé¡å‹"""
        query_lower = query.lower()

        # æŠ•è³‡æ³•è¦
        if any(keyword in query_lower for keyword in
               ["æŠ•è³‡", "è­‰åˆ¸", "è‚¡ç¥¨", "åŸºé‡‘", "æœŸè²¨", "é¸æ“‡æ¬Š"]):
            return "investment_regulations"

        # è³‡è¨Šæ­éœ²
        elif any(keyword in query_lower for keyword in
                 ["æ­éœ²", "å…¬å‘Š", "èªªæ˜æ›¸", "å…¬é–‹", "è³‡è¨Š"]):
            return "financial_disclosure"

        # æŠ•è³‡äººä¿è­·
        elif any(keyword in query_lower for keyword in
                 ["æŠ•è³‡äºº", "ä¿è­·", "æ¬Šç›Š", "ç”³è¨´", "ç³¾ç´›"]):
            return "investor_protection"

        # åˆè¦è¦æ±‚
        elif any(keyword in query_lower for keyword in
                 ["åˆè¦", "æ³•è¦", "è¦å®š", "è¦æ±‚", "ç¾©å‹™"]):
            return "compliance_requirements"

        # é¢¨éšªè­¦èª
        elif any(keyword in query_lower for keyword in
                 ["é¢¨éšª", "è­¦èª", "è²æ˜", "å‘ŠçŸ¥"]):
            return "risk_warnings"

        # åŸ·ç…§è¦æ±‚
        elif any(keyword in query_lower for keyword in
                 ["åŸ·ç…§", "è¨±å¯", "ç™»è¨˜", "æ ¸å‡†", "è³‡æ ¼"]):
            return "licensing_requirements"

        # é è¨­ç‚ºä¸€èˆ¬æŠ•è³‡æ³•è¦
        else:
            return "investment_regulations"

    async def _generate_fallback_response(self, prompt: str) -> str:
        """LLM ä¸å¯ç”¨æ™‚çš„é™ç´šå›æ‡‰"""
        return """âš–ï¸ **æ³•å¾‹æ„è¦‹**

ğŸ“‹ **ç›¸é—œæ³•è¦**
æ ¹æ“šè­‰åˆ¸äº¤æ˜“æ³•åŠç›¸é—œæ³•è¦ï¼ŒæŠ•è³‡æ´»å‹•æ‡‰éµå¾ªä»¥ä¸‹è¦ç¯„ï¼š

1. **è³‡è¨Šæ­éœ²ç¾©å‹™**ï¼šä¾è­‰åˆ¸äº¤æ˜“æ³•è¦å®šï¼Œæä¾›æ­£ç¢ºå®Œæ•´è³‡è¨Š
2. **é©åˆæ€§åŸå‰‡**ï¼šè©•ä¼°å®¢æˆ¶é¢¨éšªæ‰¿å—åº¦ï¼Œæ¨è–¦é©ç•¶å•†å“
3. **åˆ©ç›Šè¡çªç®¡ç†**ï¼šé¿å…æå®³å®¢æˆ¶æ¬Šç›Šçš„åˆ©ç›Šè¡çª

ğŸ’¡ **åˆè¦å»ºè­°**
- ç¢ºä¿æ‰€æœ‰æŠ•è³‡å»ºè­°ç¬¦åˆç›¸é—œæ³•è¦è¦æ±‚
- æä¾›å®Œæ•´çš„é¢¨éšªè­¦èªå’Œå•†å“èªªæ˜
- å»ºç«‹å®Œå–„çš„å®¢æˆ¶è³‡æ–™å’Œäº¤æ˜“è¨˜éŒ„

âš ï¸ **é¢¨éšªæé†’**
- é•åè­‰åˆ¸æ³•è¦å¯èƒ½é¢è‡¨è¡Œæ”¿è™•åˆ†
- æœªå–„ç›¡å‘ŠçŸ¥ç¾©å‹™å¯èƒ½æ‰¿æ“”æ°‘äº‹è²¬ä»»
- å»ºè­°å®šæœŸé—œæ³¨æ³•è¦ç•°å‹•

*æ³¨æ„ï¼šæ­¤ç‚ºä¸€èˆ¬æ€§æ³•å¾‹è³‡è¨Šï¼Œä¸æ§‹æˆå…·é«”æ³•å¾‹å»ºè­°ã€‚å€‹æ¡ˆå•é¡Œè«‹è«®è©¢å°ˆæ¥­å¾‹å¸«ã€‚*

**å…è²¬è²æ˜**ï¼šæœ¬æ„è¦‹åƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæ­£å¼æ³•å¾‹å»ºè­°ã€‚å…·é«”å€‹æ¡ˆè«‹è«®è©¢åŸ·æ¥­å¾‹å¸«ã€‚"""

    async def provide_legal_opinion(self, legal_question: str, context: Dict[str, Any] = None) -> Dict[str, Any]:
        """æä¾›æ³•å¾‹æ„è¦‹"""
        try:
            # ä½¿ç”¨ LLM ç”Ÿæˆæ³•å¾‹æ„è¦‹
            legal_opinion = await self._generate_llm_response(
                await self._build_prompt(legal_question, [], context or {})
            )

            return {
                "legal_opinion": legal_opinion,
                "confidence": 0.90,  # æ³•å¾‹æ„è¦‹é€šå¸¸æœ‰è¼ƒé«˜ä¿¡å¿ƒåº¦
                "sources": ["å°ç£ç›¸é—œæ³•è¦", "ä¸»ç®¡æ©Ÿé—œå‡½é‡‹", "æ³•å¾‹å¯¦å‹™"],
                "disclaimer": "æœ¬æ„è¦‹åƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæ­£å¼æ³•å¾‹å»ºè­°",
                "consultation_recommended": "é‡è¦æ±ºç­–å»ºè­°è«®è©¢å°ˆæ¥­å¾‹å¸«"
            }

        except Exception as e:
            self.logger.error(f"Error providing legal opinion: {e}")
            return {
                "legal_opinion": "ç„¡æ³•æä¾›æ³•å¾‹æ„è¦‹ï¼Œè«‹è«®è©¢å°ˆæ¥­å¾‹å¸«",
                "confidence": 0.0,
                "sources": [],
                "error": str(e)
            }

    def check_compliance_requirements(self, business_type: str, activity: str) -> Dict[str, Any]:
        """æª¢æŸ¥åˆè¦è¦æ±‚"""
        try:
            # åŸºæœ¬åˆè¦æª¢æŸ¥é …ç›®
            compliance_items = {
                "æŠ•è³‡é¡§å•": [
                    "æŠ•è³‡é¡§å•äº‹æ¥­è¨­ç½®æ¨™æº–",
                    "æŠ•è³‡é¡§å•äº‹æ¥­ç®¡ç†è¦å‰‡",
                    "è­‰åˆ¸æŠ•è³‡é¡§å•äº‹æ¥­è² è²¬äººèˆ‡æ¥­å‹™äººå“¡ç®¡ç†è¦å‰‡"
                ],
                "è­‰åˆ¸ç¶“ç´€": [
                    "è­‰åˆ¸å•†è¨­ç½®æ¨™æº–",
                    "è­‰åˆ¸å•†ç®¡ç†è¦å‰‡",
                    "è­‰åˆ¸å•†æ¥­å‹™å“¡ç®¡ç†è¦å‰‡"
                ],
                "æŠ•ä¿¡æŠ•é¡§": [
                    "è­‰åˆ¸æŠ•è³‡ä¿¡è¨—åŠé¡§å•æ³•",
                    "è­‰åˆ¸æŠ•è³‡ä¿¡è¨—äº‹æ¥­ç®¡ç†è¦å‰‡",
                    "è­‰åˆ¸æŠ•è³‡é¡§å•äº‹æ¥­ç®¡ç†è¦å‰‡"
                ]
            }

            return {
                "business_type": business_type,
                "activity": activity,
                "applicable_regulations": compliance_items.get(business_type, []),
                "recommendation": "è«‹ä¾æ“šå…·é«”æ¥­å‹™å…§å®¹è«®è©¢ä¸»ç®¡æ©Ÿé—œæˆ–å°ˆæ¥­å¾‹å¸«"
            }

        except Exception as e:
            self.logger.error(f"Error checking compliance: {e}")
            return {"error": str(e)}

    def get_legal_capabilities(self) -> Dict[str, Any]:
        """ç²å–æ³•å¾‹å°ˆæ¥­èƒ½åŠ›æè¿°"""
        return {
            "supported_domains": list(self.legal_domains.values()),
            "legal_categories": list(self.legal_categories.values()),
            "llm_configured": self.get_llm_status()["llm_configured"],
            "specializations": [
                "è­‰åˆ¸äº¤æ˜“æ³•",
                "éŠ€è¡Œæ³•è¦",
                "æŠ•è³‡äººä¿è­·",
                "é‡‘èåˆè¦",
                "é¢¨éšªè­¦èªè¦æ±‚"
            ],
            "services": [
                "æ³•è¦è«®è©¢",
                "åˆè¦æª¢æŸ¥",
                "é¢¨éšªè©•ä¼°",
                "æ³•å¾‹æ„è¦‹æ›¸",
                "åˆè¦å»ºè­°"
            ],
            "disclaimer": "æä¾›ä¸€èˆ¬æ€§æ³•å¾‹è³‡è¨Šï¼Œä¸å–ä»£å°ˆæ¥­å¾‹å¸«è«®è©¢"
        }